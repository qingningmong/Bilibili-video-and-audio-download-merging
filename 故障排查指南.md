# 视频音频合成工具 - 故障排查指南

## 问题：exe打开后闪退

### 快速诊断步骤

#### 步骤1：使用调试版本

1. 运行 `build_exe_v2.py`
2. 选择 **"2. 创建调试版本"**
3. 运行生成的调试版exe（会显示控制台窗口）
4. 查看控制台输出的错误信息

#### 步骤2：查看日志文件

调试版本会在同目录生成 `video_merger_debug.log` 文件，包含详细错误信息。

#### 步骤3：使用目录模式（更稳定）

如果单文件模式闪退，尝试目录模式：
1. 运行 `build_exe_v2.py`
2. 选择 **"1. 创建发布版本"**
3. 选择 **"1. 目录模式"**

---

## 常见闪退原因及解决方案

### 原因1：缺少tkinter支持

**症状**：打包后exe无法启动，日志显示 `ModuleNotFoundError: No module named 'tkinter'`

**解决方案**：
```bash
# 重新安装Python时确保勾选 "tcl/tk and IDLE"
# 或在Linux上:
sudo apt-get install python3-tk

# 打包时添加隐藏导入
pyinstaller --hidden-import tkinter --hidden-import tkinter.filedialog ...
```

---

### 原因2：Windows Defender / 杀毒软件拦截

**症状**：exe刚打开就消失，没有任何错误提示

**解决方案**：
1. 暂时关闭Windows Defender实时保护
2. 将exe添加到杀毒软件白名单
3. 使用目录模式（`--onedir`）代替单文件模式
4. 打包时添加 `--noupx` 参数禁用UPX压缩

---

### 原因3：缺少VC++运行库

**症状**：报错 `VCRUNTIME140.dll not found` 或类似错误

**解决方案**：
1. 下载安装 Microsoft Visual C++ Redistributable:
   - https://aka.ms/vs/17/release/vc_redist.x64.exe
2. 安装后重启电脑

---

### 原因4：路径问题（单文件模式）

**症状**：在开发环境能运行，打包后闪退

**解决方案**：
1. 使用目录模式（`--onedir`）代替单文件模式
2. 检查代码中是否使用了相对路径或假设文件存在
3. 使用 `sys._MEIPASS` 获取打包后的资源路径

---

### 原因5：FFmpeg路径问题

**症状**：界面能打开，但点击"验证"或"开始合成"时闪退

**解决方案**：
1. 确保FFmpeg路径正确设置
2. 使用绝对路径而非相对路径
3. 检查FFmpeg是否可执行

---

### 原因6：DPI/显示问题

**症状**：在高DPI屏幕上打开后立即关闭

**解决方案**：
1. 使用v2.0版本（已内置DPI支持）
2. 右键exe → 属性 → 兼容性 → 更改高DPI设置
3. 勾选"替代高DPI缩放行为"

---

## 推荐打包命令

### 最稳定的打包方式（目录模式）

```bash
pyinstaller \
    --name "VideoAudioMerger" \
    --onedir \
    --windowed \
    --noupx \
    --hidden-import tkinter \
    --hidden-import tkinter.filedialog \
    --hidden-import tkinter.messagebox \
    --hidden-import tkinter.scrolledtext \
    --hidden-import tkinter.ttk \
    --hidden-import json \
    --hidden-import subprocess \
    --hidden-import pathlib \
    --hidden-import difflib \
    --hidden-import concurrent.futures \
    --hidden-import argparse \
    --hidden-import threading \
    --hidden-import datetime \
    video_audio_merger_gui_v2.py
```

### 单文件模式（便携但有兼容性问题）

```bash
pyinstaller \
    --name "VideoAudioMerger" \
    --onefile \
    --windowed \
    --noupx \
    --hidden-import tkinter \
    --hidden-import tkinter.filedialog \
    --hidden-import tkinter.messagebox \
    --hidden-import tkinter.scrolledtext \
    --hidden-import tkinter.ttk \
    video_audio_merger_gui_v2.py
```

---

## 使用 build_exe_v2.py 自动打包

```bash
# 1. 安装依赖
python build_exe_v2.py
选择: 4

# 2. 创建发布版本（目录模式，最稳定）
python build_exe_v2.py
选择: 1 → 1

# 3. 如果仍有问题，创建调试版本
python build_exe_v2.py
选择: 2
```

---

## 手动测试Python脚本

如果exe有问题，先测试Python脚本是否能正常运行：

```bash
# 测试调试版本（带详细日志）
python video_audio_merger_gui_debug.py

# 测试v2版本
python video_audio_merger_gui_v2.py

# 测试v1版本
python video_audio_merger_gui.py
```

---

## 收集错误信息

如果以上方法都无法解决，请收集以下信息寻求帮助：

1. **操作系统版本**（如 Windows 10 21H2）
2. **Python版本**（`python --version`）
3. **PyInstaller版本**（`pyinstaller --version`）
4. **错误日志**（`video_merger_debug.log`）
5. **控制台输出**（运行调试版本时的黑窗口内容）

---

## 替代方案

如果exe始终无法正常工作，可以直接使用Python脚本：

```bash
# 1. 安装Python 3.8+
# 2. 运行脚本
python video_audio_merger_gui_v2.py
```

或使用命令行版本：
```bash
python video_audio_merger.py
```
